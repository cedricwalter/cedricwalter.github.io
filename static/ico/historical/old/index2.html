<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <link href="style.css" rel="stylesheet" />

    <!--<script src="https://d3js.org/d3.v3.min.js"></script>-->
    <script src="https://d3js.org/d3.v5.min.js"></script>

</head>
<body>

<script>
    var valueSlotCounter = 0;

    data = [
        {label: "bitcoin", ticker: "BTC", value: [ 1180,234,344,234 ]},
        {label: "Ethereum", ticker: "ETH", value: [344,234,567,123]},
        {label: "litecoin", ticker: "LTC", value: [567,123,234,34]},
        {label: "EOS", ticker: "EOS", value: [17,50,134,56]},
        {label: "Monero", ticker: "XMR", value: [234,34,78,154]},
        {label: "Ripple", ticker: "XMR", value: [134,56,234,567]},
        {label: "Cardano", ticker: "XMR", value: [367,560,367,345]},
        {label: "Monero", ticker: "XMR", value: [234,345,134,56]},
        {label: "XRP", ticker: "XRP", value: [78,154,567,123]}
    ];

    var div = d3.select("body").append("div").attr("class", "toolTip");
    var axisMargin = 20,
        margin = 40,
        valueMargin = 4,
        width = parseInt(d3.select('body').style('width'), 10),
        height = parseInt(d3.select('body').style('height'), 10),
        barHeight = (height - axisMargin - margin * 2) * 0.4 / data.length,
        barPadding = (height - axisMargin - margin * 2) * 0.6 / data.length,
        data, bar, svg, scale, xAxis, labelWidth = 0;

var color = d3.scaleOrdinal(d3.schemeCategory20);

    svg = d3.select('body')
            .append("svg")
            .attr("width", width)
            .attr("height", height);

            max = d3.max(data, function (d) {
                return d.value[valueSlotCounter];
            });

            bar = svg.selectAll("g")
                .data(data)
                .enter()
                .append("g");

            bar.attr("class", function (d) {
                return color(d.ticker);
            })
                .attr("cx", 0)
                .attr("transform", function (d, i) {
                    return "translate(" + margin + "," + (i * (barHeight + barPadding) + barPadding) + ")";
                });

            bar.append("text")
                .attr("class", "label")
                .attr("y", barHeight / 2)
                .attr("dy", ".35em") //vertical align middle
                .text(function (d) {
                    return d.label;
                }).each(function () {
                labelWidth = Math.ceil(Math.max(labelWidth, this.getBBox().width));
            });

            scale = d3.scaleLinear()
                .domain([0, max])
                .range([0, width - margin * 2 - labelWidth]);

            xAxis = d3.axisBottom(scale)
            .tickSize(-height + 2 * margin + axisMargin)
            .tickFormat(function(d){ return d.x;});

            /* d3.svg.axis()
                .scale(scale)
                .tickSize(-height + 2 * margin + axisMargin)
                .orient("bottom"); */

            bar.append("rect")
                .attr("transform", "translate(" + labelWidth + ", 0)")
                .attr("height", barHeight)
                .attr("width", function (d) {
                    return scale(d.value[valueSlotCounter]);
                });

            bar.append("text")
                .attr("class", "value")
                .attr("y", barHeight / 2)
                .attr("dx", -valueMargin + labelWidth) //margin right
                .attr("dy", ".35em") //vertical align middle
                .attr("text-anchor", "end")
                .text(function (d) {
                    return (" " + d.value[valueSlotCounter] + "");
                })
                .attr("x", function (d) {
                    var width = this.getBBox().width;
                    return Math.max(width + valueMargin, scale(d.value[valueSlotCounter])) + width + valueMargin ;
                });

            bar
                .on("mousemove", function (d) {
                    div.style("left", d3.event.pageX + 10 + "px");
                    div.style("top", d3.event.pageY - 25 + "px");
                    div.style("display", "inline-block");
                    div.html((d.label) + "<br>" + (d.value[valueSlotCounter]) + "");
                });
            bar
                .on("mouseout", function (d) {
                    div.style("display", "none");
                });

            svg.insert("g", ":first-child")
                .attr("class", "axisHorizontal")
                .attr("transform", "translate(" + (margin + labelWidth) + "," + (height - axisMargin - margin) + ")")
                .call(xAxis);

    const interval = d3.interval(() => {
            const t = d3.transition().duration(400);

            if (valueSlotCounter === 3) {
              interval.stop();
            }

            bar.select('rect')
                  .attr('width',0) //<-- width 0
                  .transition()
                  .duration(1500)
                  .attr("width", function(d){return scale(d.value[valueSlotCounter]);});

                  svg.selectAll("text")
                     .data(data)
                     .enter()
                     .append("text").text(function(d) {
                       return d.value[valueSlotCounter];
                     });


            /*bar.select('text')
                  .text(function (d) {
                      return ("");
                  }).transition()
                  .duration(1500)
                  .text(function (d) {
                      return (" " + d.value[valueSlotCounter] + "");
                  }).attr("x", function (d) {
                      var width = this.getBBox().width;
                      return Math.max(width + valueMargin, scale(d.value[valueSlotCounter])) + width + valueMargin ;
                  });;*/

            valueSlotCounter++;
        }, 1000);


</script>
</body>
